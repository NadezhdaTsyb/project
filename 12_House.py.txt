import logging
from telegram import Update, ReplyKeyboardMarkup, InputFile
from telegram.ext import (
    Application,
    CommandHandler,
    MessageHandler,
    filters,
    CallbackContext
)

# Настройка логгирования
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

TOKEN = "7698498351:AAEr9wUaikJ3-77AS09lnTSzfixszVLUgxQ"

# Список знаков зодиака
ZODIAC_SIGNS = [
    ["♈ Овен", "♉ Телец", "♊ Близнецы"],
    ["♋ Рак", "♌ Лев", "♍ Дева"],
    ["♎ Весы", "♏ Скорпион", "♐ Стрелец"],
    ["♑ Козерог", "♒ Водолей", "♓ Рыбы"]
]


async def set_bot_photo(application: Application):
    """Устанавливает аватарку для бота"""
    try:
        # Путь к изображению (должен быть в той же папке или указан полный путь)
        photo_path = "zodiac_bot_avatar.png"

        # Открываем файл и отправляем как аватар
        with open(photo_path, 'rb') as photo_file:
            await application.bot.set_bot_profile_photo(photo=InputFile(photo_file))
        logger.info("Аватар бота успешно установлен")
    except Exception as e:
        logger.error(f"Ошибка при установке аватара: {e}")


async def post_init(application: Application):
    """Функция инициализации после запуска"""
    await set_bot_photo(application)


async def start(update: Update, context: CallbackContext) -> None:
    """Обработчик команды /start"""
    user = update.effective_user
    await update.message.reply_text(
        f"Привет, {user.first_name}! Выбери свой знак зодиака:",
        reply_markup=ReplyKeyboardMarkup(
            ZODIAC_SIGNS,
            resize_keyboard=True,
            one_time_keyboard=False
        )
    )


async def handle_zodiac(update: Update, context: CallbackContext) -> None:
    """Обработчик выбора знака зодиака"""
    selected_sign = update.message.text
    response = get_zodiac_response(selected_sign)
    await update.message.reply_text(
        response,
        reply_markup=ReplyKeyboardMarkup(
            ZODIAC_SIGNS,
            resize_keyboard=True
        )
    )

def get_zodiac_response(sign: str) -> str:
    """Возвращает описание для выбранного знака зодиака"""
    descriptions = {
        "♈ Овен": "Овен - полностью оправдывает свое символическое название: это упёртые, смелые и пробивные люди, родившиеся в период с 21 марта по 20 апреля. Овны, будучи огненным знаком, практически всегда полны энергии. Им нравится быть первыми, открывать что-то новое и неизведанное. Овны обычно открыты, прямолинейны и честны. Они ценят искренность и ожидают её от других. Если овнам что-то интересно, они стараются полностью и досконально это изучить. Однако иногда овны могут быть чересчур импульсивными и вспыльчивыми. Им стоит научиться контролировать свои эмоции и действия. Им бывает сложно прижиться в коллективе, поскольку они не терпят ограничений и не любят находиться в подчинении.",
        "♉ Телец": "Люди, родившиеся в период с 21 апреля по 20 мая, отличаются невероятной пытливостью ума, широким кругозором и сильным творческим началом. Несмотря на «приземлённость» знака, тельцы тонко чувствуют этот мир. В то же время тельцы обычно стремятся к стабильности, ценят комфорт и удобство. Однако чувственные тельцы нередко оказываются прокрастинаторами. Как правило, это связано не с леностью знака, а со внутренними переживаниями. Если таковые отсутствуют — телец способен на всё. Тельцы обычно верные и преданные друзья и партнёры. Они ценят долгосрочные отношения и готовы делать всё возможное для сохранения близких связей. Однако милые на первый взгляд тельцы способны на месть, но только в том случае, если их чувства были по-настоящему задеты. Стоит отметить и забывчивость тельцов. Этот знак довольно часто попадает в разного рода казусные ситуации, однако от этого они не теряют оптимизма.",
        "♊ Близнецы": "Запоминающиеся и загадочные близнецы обладают ярким характером: им легко устанавливать контакты с окружающими и находить общий язык с самыми разными людьми. Близнецы легко адаптируются к новым ситуациям и быстро меняют свои планы в зависимости от обстоятельств. Люди, родившиеся в период с 21 мая по 21 июня, обладают острым умом, любопытны и стремятся к знаниям. Однако иногда они могут казаться противоречивыми или непредсказуемыми. Довольно часто близнецов называют ветреными, но это совсем не так. На самом деле они просто не любят монотонность и стремятся к разнообразию в жизни, однако это не делает их непостоянными партнёрами. Несмотря на интеллектуальную сторону своей личности, близнецы также могут быть очень эмоциональными и открытыми в выражении своих чувств, иногда даже чересчур.",
        "♋ Рак": "Это самый чувственный и сентиментальный знак зодиака. Раки обладают врождённой способностью к эмпатии. Люди, родившиеся в период с 21 июня по 22 июля, очень привязаны к семье и домашнему уюту. Они ценят тёплые отношения с близкими и готовы жертвовать своим временем и энергией для поддержки своих родных. Они готовы стать опорой в трудные моменты и защищать тех, кого любят. Однако из-за своей высокой эмоциональности раки могут быть переменчивы в настроении. Им важно находить баланс между своими чувствами и разумом. Нередко сказанные в их адрес слова они воспринимают буквально. Им сложно выслушивать критику. Несмотря на их яркий характер, харизму и способность к сопереживанию, раки — довольно закрытые люди. Им проще выслушать другого, нежели открыто рассказать о своих переживаниях.",
        "♌ Лев": "Энергичные, смелые и уверенные львы обладают сильным характером. Они уверены в себе и готовы брать на себя лидирующую роль. Они настоящие завоеватели сердец. Причем завоёвывают их они ненамеренно. Это происходит благодаря их внутреннему огню и страсти к жизни. Львы умеют находить позитивные стороны даже в трудных ситуациях и могут поддерживать окружающих своим оптимизмом. Однако люди, родившиеся в период с 23 июля по 22 августа, могут вести себя так, будто им принадлежит мир, что может вызывать раздражение у окружающих. Также львы могут быть очень зависимы от похвалы и внимания со стороны окружающих. Тем не менее львы обычно очень щедрые и добрые. Они готовы помочь другим и поделиться даже чем-то очень ценным.",
        "♍ Дева": "Перфекционизм, любовь к порядку — как вокруг, так и в голове — это то, что отличает дев от других знаков зодиака. Девы обычно скромны и не любят быть в центре внимания. Они предпочитают работать в «закулисье», тщательно выполняя свои обязанности. Иногда девы могут быть слишком критичными по отношению к себе и другим, от чего нередко страдают от заниженной самооценки. Хотя на деле они должны по-настоящему ценить себя, поскольку обладают острым умом и способностью анализировать сложные ситуации. Они, в отличие от других знаков, могут быстро находить решения проблем и видеть малозаметные детали, которые ускользают от других. Люди, родившиеся в период с 23 августа по 23 сентября, могут быть хорошими советчиками благодаря своей способности мыслить рационально.",
        "♎ Весы": "Обаятельные весы ценят справедливость и честность. В то же время они ценят свою индивидуальность и стремятся к самореализации. Также люди, родившиеся в период с 24 сентября по 23 октября, обычно обладают способностью находить компромиссы и решать конфликты мирным путём. Иными словами, весы — настоящие дипломаты. Нередко представители этого знака могут быть творческими и иметь хороший вкус. Однако весы могут быть неуверенными в своих действиях, что иногда делает их неспособными принять ответственность. Также они могут тратить слишком много времени на взвешивание всех возможных вариантов, что может затруднить процесс принятия решения.",
        "♏ Скорпион": "Вокруг этого знака ходит много разговоров. Кто-то считает скорпионов выскочками и эгоистами, неспособными на партнёрские отношения. Кто-то, напротив, считает скорпионов людьми ранимыми и верными. На самом же деле, напомним, всё зависит от человека, а не от его знака зодиака. Тем не менее о людях, рождённых в период с 24 октября по 22 ноября, можно сказать, что они обладают страстным характером. Это позволяет им полностью погружаться в то, что они делают. Скорпионы также могут быстро распознавать скрытые мотивы и чувства других людей. По этой же причине скорпионы могут быть подозрительными и недоверчивыми к окружающим, что может создавать проблемы в их отношениях с другими людьми.",
        "♐ Стрелец": "Целеустремлённые, сильные и чуткие стрельцы рождаются в период с 23 ноября по 21 декабря. Их отличает огненный нрав и невероятная жажда добиваться поставленных целей. Стрельцы щедры и справедливы. На скупости их подловить сложно. Стрельцы открыты для новых идей и готовы рисковать в поисках своего собственного пути. По этой же причине представители знака могут быть склонны к принятию быстрых решений без должного обдумывания последствий. Несмотря на все жизненные сложности, стрельцы обычно полны оптимизма и веры в лучшее. Они могут вдохновлять окружающих своим позитивным отношением к жизни.",
        "♑ Козерог": "Козероги любят «пободаться». Однако это не значит, что люди, рождённые в период с 22 декабря по 20 января, не умеют дружить и строить романтические отношения. Наоборот, их задор и энергия вдохновляют близких. В то же время козероги обычно ориентированы на практические аспекты жизни и могут быть хорошими организаторами. Они способны рационально мыслить и принимать обдуманные решения. А ещё они очень настойчивые, целеустремлённые и мотивированные. Несмотря на их внешнюю силу, иногда козероги могут быть склонны к замкнутости. Это, как правило, приводит к избеганию выражения своих эмоций.",
        "♒ Водолей": "Мистические, харизматичные, экстравагантные и обаятельные водолеи рождаются в период с 21 января по 18 февраля. Водолеи с головой способны погрузиться в то, что их по-настоящему интересует. Однако иногда это переходит в обсессию. Водолеи свободолюбивы: они часто стремятся к независимости и ценят свою индивидуальность и нонконформизм. Они не боятся выделяться из толпы. Иногда их поведение кажется окружающим эксцентричным. Они не готовы жертвовать собственным комфортом, чтобы казаться кому-то «хорошим». Непредсказуемость водолеев усложняет понимание их настроения, а иногда и поведения.",
        "♓ Рыбы": "Трогательные, ранимые, но в то же время невероятно сильные и мудрые. Рыбы философски подходят к жизни, с самого рождения отличаясь особым миропониманием. Однако нередко по этой причине они становятся «белыми воронами». Это не значит, что они страдают от социофобии, скорее, их круг близких ограничен, но это не приносит им дискомфорта. Рыбы обладают художественным талантом и развитым воображением, что помогает им выражать свои чувства и идеи через искусство. В то же время из-за этого рыбы иногда могут быть склонны к чрезмерной мечтательности, что может мешать им видеть реальность такой, какая она есть, и приводить к разочарованиям."
    }
    return descriptions.get(sign, "Пожалуйста, выберите знак зодиака из списка.")

async def help_command(update: Update, context: CallbackContext) -> None:
    """Обработчик команды /help"""
    await update.message.reply_text(
        "Просто выберите свой знак зодиака на клавиатуре.\n"
        "Используйте /start чтобы вернуться к выбору знака.",
        reply_markup=ReplyKeyboardMarkup(
            ZODIAC_SIGNS,
            resize_keyboard=True
        )
    )

def main() -> None:
    """Запуск бота"""
    # Важно: передаем post_init в builder
    application = Application.builder() \
        .token(TOKEN) \
        .post_init(post_init) \
        .build()

    # Регистрация обработчиков
    application.add_handler(CommandHandler("start", start))
    application.add_handler(CommandHandler("help", help_command))
    application.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_zodiac))

    # Запуск бота
    application.run_polling()

if __name__ == "__main__":
    main()